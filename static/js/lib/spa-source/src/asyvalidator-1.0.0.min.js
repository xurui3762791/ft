(function(r,g,B){function k(a){return 0===arguments.length||"undefined"===typeof a?"undefined":null===a?"null":y.call(a)}function z(){for(var a="",b=1;32>=b;b++){var c=Math.floor(16*Math.random()).toString(16),a=a+c;if(8==b||12==b||16==b||20==b)a+="-"}return a}function t(){this._isSubmit=!1}function A(a){function b(){}b.prototype=a.prototype;return b}function v(){this.eventList={}}function n(a,b){n.baseConstructor.call(this);this.set=g.extend({},{stopOnError:!1,timely:!0,cacheValidResult:!0,fields:{},
rules:{},XHRDataAdapters:{},defaultXHRDataAdapter:function(a){return 200==a.code?{type:"ok",msg:a.msg}:{type:"error",msg:a.msg}},commonRules:{},msgMaker:function(a){return"<span class='"+a.type+"'>"+a.msg+"</span>"}},b);this.form=null;this.set.commonRules=g.extend({},{require:function(a,b,d){return""==g.trim(a.val())?{type:"error",msg:d.msg.require}:{type:"ok",msg:""}},mobile:function(a,b,d){return/^1[3-9]\d{9}$/.test(g.trim(a.val()))?{type:"ok",msg:""}:{type:"error",msg:d.msg.mobile}},radioChecked:function(a,
b,d){var f=!1;a.each(function(){if(this.checked)return f=!0,!1});return f?{type:"ok",msg:""}:{type:"error",msg:d.msg.radioChecked||"\u8bf7\u9009\u62e9"}},checkBoxChecked:function(a,b,d){var f=null,e=null,g=b.length,h={type:null,msg:""},p=0;a.each(function(){this.checked&&(p+=1)});a={min:function(a){return"\u81f3\u5c11\u9009\u62e9"+a+"\u9879"},max:function(a){return"\u6700\u591a\u53ea\u80fd\u9009\u62e9"+a+"\u9879"},between:function(a,b){return"\u8bf7\u9009\u62e9"+a+"-"+b+"\u9879"}};0==g?f=1:1==g?f=
b[0]:2==g&&(f=b[0],e=b[1]);null===f&&null!==e?p>e?(h.type="error",h.msg=d.msg.checkBoxChecked||a.max(e)):h.type="ok":null!==f&&null===e?p<f?(h.type="error",h.msg=d.msg.checkBoxChecked||a.min(f)):h.type="ok":null!==f&&null!==e&&(p<f||p>e?(h.type="error",h.msg=d.msg.checkBoxChecked||a.between(f,e)):h.type="ok");return h}},this.set.commonRules);this.commonRules=this.set.commonRules;this.rules=this.set.rules;this.fields=this.set.fields;this.fieldsStateList={};this.XHRDataAdapters=this.set.XHRDataAdapters;
if(!a)return console.log("undefined form"),!1;a=g(a).eq(0);if(0==a.size())return console.log("undefined form"),!1;this.form=a;this.xhrList={};this.init()}r.console||(r.console={log:function(a){}});var y=Object.prototype.toString;t.prototype={holder:function(a){this._isSubmit||(this._isSubmit=!0,a.call(this))},reset:function(){this._isSubmit=!1}};var w={is_array:function(a){return"[object Array]"===k(a)},is_string:function(a){return"[object String]"===k(a)},is_number:function(a){return"[object Number]"===
k(a)},is_object:function(a){return"[object Object]"===k(a)},is_function:function(a){return"[object Function]"===k(a)},is_null:function(a){return"null"===k(a)},is_undefined:function(a){return"undefined"===k(a)}};v.prototype={getEventList:function(a){return"undefined"!==typeof this.eventList[a]?this.eventList[a]:[]},bind:function(a,b){this.eventList[a]=this.getEventList(a);this.eventList[a].push(b);return this},trigger:function(a){for(var b=this.getEventList(a),c=0,l=b.length,d=Array.prototype.slice.call(arguments,
1);c<l;c++)if(!1===b[c].apply(this,d))return!1;return!0},unbind:function(a){0==arguments.length?this.eventList=null:delete this.eventList[a]}};(function(a,b){var c=A(b);a.prototype=new c;a.prototype.constructor=a;a.baseConstructor=b;a.superClass=b.prototype})(n,v);n.Once=t;n.prototype=g.extend({},n.prototype,{isXHRPromise:function(a){return w.is_object(a)&&w.is_function(a.then)},getXHRDataAdapter:function(a){return this.XHRDataAdapters[a]||this.set.defaultXHRDataAdapter},getField:function(a){var b=
this.fields[a];b&&(b.key=a);return b||null},getRule:function(a){return this.rules[a]||this.commonRules[a]||null},initField:function(a){var b=this,c=this.getInput(a),l=this.getField(a),d=new t;l.key=a;if(c)c.on("blur.asyValidInput",function(){if(!b.set.timely)return!1;d.holder(function(){b.initFieldValidByFieldKey(a,function(){d.reset()},function(){d.reset()})})}).on("change.asyValidInput",function(){b.resetFieldState(a)})},resetFieldState:function(a){delete this.fieldsStateList[a]},unbindEvents:function(){var a=
this;g.each(this.fields,function(b,c){var l=a.getInput(b);c=a.getField(b);console.log(c);a.unbindInput(l)});g.each(this.xhrList,function(b,c){a.abortXHR(b)});this.form.off("click.asyValidFormBubble");this.form.off("submit.asyVaidForm")},unbindInput:function(a){a&&a.off("blur.asyValidInput").off("change.asyValidInput")},destroy:function(){this.unbindEvents()},init:function(){var a=this,b=this.form,c=new t;g.each(this.fields,function(b,d){a.initField(b)});this.form.on("submit.asyVaidForm",function(l){l.preventDefault();
c.holder(function(){!1!==a.trigger("form.beforeValid",b)&&a.multiVald(a.getFieldKeys(),function(d,f){a.trigger("form.afterValid",d,b);0<d.length?a.trigger("form.validError",d,b):a.trigger("form.validSuccess",f,b);c.reset()})})});this.form.on("click.asyValidFormBubble","[type='checkbox'], [type='radio']",function(b){b=g(this);a.resetFieldState(b.attr("name"));b.trigger("blur.asyValidInput")})},getFieldKeys:function(){var a=[];g.each(this.fields,function(b){a.push(b)});return a},getFields:function(a){var b=
this,c=[];g.each(a,function(a,d){var f=b.getField(d);f.key=d;c.push({field:f,fieldKey:d})});return c},multiVald:function(a,b){function c(){b.call(l,k,h)}var l=this;b=b||function(){};var d=l.set.stopOnError,f=this.getFields(a),e=0,k=[],h=[];d?function(){var a=arguments.callee;l.initFieldValidByFieldKey(f[e].fieldKey,function(b){h.push(b);e+=1;e==f.length?c():a()},function(a){k.push(a);c()})}():g.each(f,function(a,b){l.initFieldValidByFieldKey(b.fieldKey,function(a){h.push(a);e+=1;e==f.length&&c()},
function(a){e+=1;k.push(a);e==f.length&&c()})})},getRuleObj:function(a){a=g.trim(a);var b=[],c=[],l={funcName:a,paramList:[]};a=a.match(/(.+)\[(.*)\]$/);null!==a&&(l.funcName=a[1],b=a[2].replace(/^(\,+)/,"").replace(/(\,+)$/,"").split(/\s*,\s*/));g.each(b,function(a,b){"null"===b?b=null:"true"===b?b=!0:"false"===b&&(b=!1);c.push(b)});l.paramList=c;return l},isIdMode:function(a){return/^#/.test(a)},getInput:function(a){return this.isIdMode(a)?this.form.find(a):this.form.find("[name='"+a+"']")},renderMsg:function(a){var b=
g.extend({msgWraper:null,msg:"",type:"ok",isShow:!0},a);a=b.isShow;var c=b.msgWraper,b=this.set.msgMaker(b);c&&(c=g(c),c.empty().append(b).hide(),a?c.show():c.hide())},getFieldState:function(a){return this.fieldsStateList[a]||null},fieldIsValid:function(a){a=this.getFieldState(a);return null===a?!1:"ok"===a.type},outputMsg:function(a,b,c){var g=!1;a&&(g=b.showOkMsg?c.msg?!0:b.showOkEmptyMsg?!0:!1:!1,this.renderMsg({msgWraper:a,msg:c.msg,type:c.type,isShow:g}))},addField:function(a,b){b=g.extend({},
{key:a},b);this.fields[a]=b;this.initField(a)},deleteField:function(a){var b=this.getInput(a);this.unbindInput(b);delete this.fields[a]},setXHR:function(a,b){this.xhrList[a]=b},abortXHR:function(a){"undefined"!==typeof this.xhrList[a]&&this.xhrList[a].abort()},initFieldValid:function(a,b,c,l){b=b||null;c=c||function(){};l=l||function(){};var d=this,f=a.key||z(),e,k,h,p,n=-1,t={};a=g.extend({},{rule:null,target:null,showErrorMsg:!0,showLoadingMsg:!0,showOkMsg:!0,showOkEmptyMsg:!1,msg:{}},a);e=d.getFieldState(f);
k=d.fieldIsValid(f);a.msg=g.extend({},{require:"\u4e0d\u80fd\u4e3a\u7a7a",mobile:"\u624b\u673a\u53f7\u7801\u683c\u5f0f\u9519\u8bef"},a.msg);null!==b&&(b=g(b),0==b.size()&&(b=null));b||console.log("input null");if(!f)return console.log("undefined fieldKey"),null;if(!g.trim(a.rule))return console.log("empty rule"),null;p=g.trim(a.rule).replace(/^(\;+)/,"").replace(/(\;+)$/,"").split(/\s*\;\s*/);if(0==p.length)return console.log("ruleNameList empty"),null;a.target&&(h=g(a.target).eq(0));h&&h.attr("data-for-field",
f);if(d.set.cacheValidResult){if(!0===k){d.outputMsg(h,a,e);d.trigger("field."+f+".validSuccess",e,b);c.call(d,e);return}if(null!==e){d.outputMsg(h,a,e);d.trigger("field."+f+".validError",e,b);l.call(d,e);return}}(function(){if(n+1!=p.length){n+=1;var e=g.Deferred(),k,m,r,u,v=arguments.callee,q,x;r=p[n];k=d.getRuleObj(r);u=k.funcName;m=d.getRule(k.funcName);t[k.funcName]?console.log("current rulePromise is runing.."):(x=e.promise(),t[k.funcName]=x,m?(m=m.call(d,b,k.paramList,a,h),m.fieldKey=f,m.rule=
u,!0===m?e.resolve({rule:u,fieldKey:f,type:"ok",msg:""}):!1===m?e.reject({type:"error",rule:u,fieldKey:f,msg:a.msg[r]||""}):d.isXHRPromise(m)?(d.setXHR(u,m),m.done(function(a){q=w.is_string(a)?(new Function("return "+a))():a;q=d.getXHRDataAdapter(k.funcName)(q);q.fieldKey=f;q.rule=u;"ok"===q.type?e.resolve(q):e.reject(q)}).fail(function(a,b){console.log(a,b);e.reject({rule:u,fieldKey:f,type:"error",msg:"abort"==b?"":b})})):w.is_object(m)&&("ok"===m.type?e.resolve(m):e.reject(m)),x.done(function(e){n+
1==p.length&&(d.fieldsStateList[f]=e,d.trigger("field."+f+".validSuccess",e,b),c.call(d,e));h&&d.outputMsg(h,a,e);v()}).fail(function(c){d.fieldsStateList[f]=c;d.outputMsg(h,a,c);d.trigger("field."+f+".validError",c,b);l.call(d,c)})):(console.log("func "+k.funcName+" is undefined"),v()))}})()},initFieldValidByFieldKey:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.getInput(a),g=this.getField(a);b.unshift(g,c);this.initFieldValid.apply(this,b)}});"function"==typeof define&&define.amd&&
define([],function(){return n});r.AsyValidator=n})(window,jQuery);